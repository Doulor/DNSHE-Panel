<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>DNS å¤šè´¦å·ç®¡ç†é¢æ¿</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <!-- ç™»å½•æ¨¡æ€æ¡† -->
  <div id="loginModal" class="modal login-modal">
    <div class="modal-content login-content">
      <div class="modal-header">
        <h3>ğŸ” DNSç®¡ç†é¢æ¿ç™»å½•</h3>
      </div>
      <input type="password" id="loginPassword" class="login-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
      <div class="remember-container">
        <input type="checkbox" id="rememberPassword">
        <label for="rememberPassword">è®°ä½å¯†ç </label>
      </div>
      <button id="loginBtn" class="login-btn">ğŸ” ç™»å½•</button>
      <div id="loginFeedback" class="login-feedback"></div>
    </div>
  </div>

  <h1>ğŸ” DNS å¤šè´¦å·ç®¡ç†é¢æ¿</h1>

  <div class="header-actions">
    <button id="refreshBtn" class="btn btn-primary">
      <span>ğŸ”„</span> åˆ·æ–°å­åŸŸå
    </button>
    <button id="registerBtn" class="btn btn-success">
      <span>â•</span> æ³¨å†Œæ–°å­åŸŸ
    </button>
  </div>

  <table id="subdomainTable">
    <thead>
      <tr>
        <th>ğŸŒ å­åŸŸå</th>
        <th>ğŸ  æ ¹åŸŸ</th>
        <th>âœ… çŠ¶æ€</th>
        <th>ğŸ‘¤ æ‰€å±è´¦å·</th>
        <th>ğŸ“… åˆ›å»ºæ—¶é—´</th>
        <th>â° åˆ°æœŸæ—¶é—´</th>
        <th>âš™ï¸ æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<!-- æ³¨å†Œå­åŸŸå¼¹çª— -->
<div id="modal" class="modal">
  <div class="modal-content">
    <button id="modalCloseBtn1" class="modal-close-btn">Ã—</button>
    <div class="modal-header">
      <h3>â• æ³¨å†Œæ–°å­åŸŸ</h3>
    </div>
    <label>é€‰æ‹©è´¦å·:</label>
    <select id="accountSelect"></select>
    <label>å­åŸŸå‰ç¼€:</label>
    <input id="subdomainInput" placeholder="ä¾‹å¦‚: myapp">
    <label>æ ¹åŸŸå:</label>
    <input id="rootdomainInput" placeholder="ä¾‹å¦‚: example.com">
    <div class="modal-buttons">
      <button id="submitRegister" class="btn btn-success">âœ… æ³¨å†Œ</button>
      <button id="closeModal" class="btn btn-danger">âŒ å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- DNSè®°å½•ç®¡ç†å¼¹çª— -->
<div id="dnsModal" class="modal">
  <div class="modal-content" style="width: 90%; max-width: 1000px;">
    <div class="modal-header">
      <h3 id="dnsModalTitle">ğŸ“‹ DNSè®°å½•ç®¡ç†</h3>
      <div class="modal-actions">
        <button id="addDNSRecordBtn" class="modal-btn add-btn">â• æ–°å¢</button>
        <button id="closeDNSModal" class="modal-btn cancel-btn">âŒ</button>
      </div>
    </div>
    <table id="dnsTable" style="margin-top: 10px;">
      <thead>
        <tr>
          <th>ğŸ·ï¸ åç§°</th>
          <th>ğŸ“Š ç±»å‹</th>
          <th>ğŸ“ å†…å®¹</th>
          <th>â±ï¸ TTL</th>
          <th>âš¡ ä¼˜å…ˆçº§</th>
          <th>ğŸ“… åˆ›å»ºæ—¶é—´</th>
          <th>âš™ï¸ æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- æ·»åŠ DNSè®°å½•å¼¹çª— -->
<div id="addDNSModal" class="modal">
  <div class="modal-content">
    <button id="modalCloseBtn3" class="modal-close-btn">Ã—</button>
    <div class="modal-header">
      <h3>â• æ·»åŠ DNSè®°å½•</h3>
    </div>
    <label>ğŸ·ï¸ è®°å½•åç§° (å¯é€‰):</label>
    <input id="dnsNameInput" placeholder="ä¾‹å¦‚: www (ç•™ç©ºåˆ™ä½¿ç”¨@)">
    <label>ğŸ“Š è®°å½•ç±»å‹:</label>
    <select id="dnsTypeSelect">
      <option value="A">Aè®°å½• - IPv4åœ°å€</option>
      <option value="AAAA">AAAAè®°å½• - IPv6åœ°å€</option>
      <option value="CNAME">CNAME - åˆ«åè®°å½•</option>
      <option value="MX">MXè®°å½• - é‚®ä»¶äº¤æ¢</option>
      <option value="TXT">TXTè®°å½• - æ–‡æœ¬è®°å½•</option>
      <option value="SRV">SRVè®°å½• - æœåŠ¡å®šä½</option>
      <option value="NS">NSè®°å½• - åŸŸåæœåŠ¡å™¨</option>
    </select>
    <label>ğŸ“ è®°å½•å†…å®¹:</label>
    <input id="dnsContentInput" placeholder="æ ¹æ®ç±»å‹å¡«å†™å¯¹åº”å†…å®¹">
    <label>â±ï¸ TTL (ç”Ÿå­˜æ—¶é—´):</label>
    <input id="dnsTTLInput" type="number" placeholder="TTLå€¼ (é»˜è®¤: 120)" value="120" min="60" max="86400">
    <label>âš¡ ä¼˜å…ˆçº§ (ä»…MX/SRV):</label>
    <input id="dnsPriorityInput" type="number" placeholder="ä¼˜å…ˆçº§ (å¯é€‰)" value="0" min="0" max="65535">
    <div class="modal-buttons">
      <button id="submitDNSRecord" class="btn btn-success">âœ… æ·»åŠ è®°å½•</button>
      <button id="closeAddDNSModal" class="btn btn-danger">âŒ å–æ¶ˆ</button>
    </div>
    <div class="help-text">
      <h4>â„¹ï¸ å‚æ•°è¯´æ˜:</h4>
      <ul>
        <li><strong>Aè®°å½•:</strong> æŒ‡å‘IPv4åœ°å€ï¼Œå¦‚ "192.168.1.1"</li>
        <li><strong>AAAAè®°å½•:</strong> æŒ‡å‘IPv6åœ°å€ï¼Œå¦‚ "2001:db8::1"</li>
        <li><strong>CNAME:</strong> æŒ‡å‘å¦ä¸€ä¸ªåŸŸåï¼Œå¦‚ "example.com"</li>
        <li><strong>MXè®°å½•:</strong> é‚®ä»¶æœåŠ¡å™¨ï¼Œå¦‚ "mail.example.com"ï¼Œéœ€è®¾ç½®ä¼˜å…ˆçº§</li>
        <li><strong>TXTè®°å½•:</strong> æ–‡æœ¬å†…å®¹ï¼Œå¦‚éªŒè¯ä¿¡æ¯ "v=spf1 include:_spf.google.com ~all"</li>
        <li><strong>TTL:</strong> ç¼“å­˜æ—¶é—´ï¼Œæ•°å€¼è¶Šå°æ›´æ–°è¶Šå¿«ï¼Œä½†æŸ¥è¯¢æ›´å¤šï¼Œé»˜è®¤120ç§’</li>
      </ul>
    </div>
  </div>
</div>

<script>
// ç™»å½•éªŒè¯ç›¸å…³å…ƒç´ 
const loginModal = document.getElementById('loginModal');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const rememberPassword = document.getElementById('rememberPassword');
const loginFeedback = document.getElementById('loginFeedback');

// é¡µé¢ä¸»è¦å…ƒç´ 
const refreshBtn = document.getElementById('refreshBtn');
const registerBtn = document.getElementById('registerBtn');
const tableBody = document.querySelector('#subdomainTable tbody');
const modal = document.getElementById('modal');
const closeModal = document.getElementById('closeModal');
const submitRegister = document.getElementById('submitRegister');
const dnsModal = document.getElementById('dnsModal');
const closeDNSModal = document.getElementById('closeDNSModal');
const addDNSRecordBtn = document.getElementById('addDNSRecordBtn');
const addDNSModal = document.getElementById('addDNSModal');
const closeAddDNSModal = document.getElementById('closeAddDNSModal');
const submitDNSRecord = document.getElementById('submitDNSRecord');
const accountSelect = document.getElementById('accountSelect');

// æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
const modalCloseBtn1 = document.getElementById('modalCloseBtn1');
const modalCloseBtn2 = document.getElementById('modalCloseBtn2');
const modalCloseBtn3 = document.getElementById('modalCloseBtn3');

let currentSubdomainId = null;
let currentAccountIndex = null;
let isAuthenticated = false;

// æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„å¯†ç 
function checkStoredCredentials() {
  const storedPassword = localStorage.getItem('dnsPanelPassword');
  const storedRemember = localStorage.getItem('rememberPassword') === 'true';

  if (storedRemember && storedPassword) {
    loginPassword.value = storedPassword;
    rememberPassword.checked = true;
    // è‡ªåŠ¨å°è¯•ç™»å½•
    attemptAutoLogin(storedPassword);
  } else {
    loginModal.style.display = 'flex';
    loginPassword.focus();
  }
}

// è‡ªåŠ¨ç™»å½•å°è¯•
async function attemptAutoLogin(password) {
  try {
    const response = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const result = await response.json();

    if (result.success) {
      isAuthenticated = true;
      loginModal.style.display = 'none';
      loadSubdomains();
    } else {
      // è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•æ¡†
      loginModal.style.display = 'flex';
      loginPassword.focus();
    }
  } catch (error) {
    console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
    // è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•æ¡†
    loginModal.style.display = 'flex';
    loginPassword.focus();
  }
}

// ç™»å½•åŠŸèƒ½
loginBtn.addEventListener('click', async () => {
  const password = loginPassword.value;
  if (!password) {
    showLoginFeedback('è¯·è¾“å…¥å¯†ç ', 'error');
    loginPassword.focus();
    return;
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  loginBtn.textContent = 'ç™»å½•ä¸­...';
  loginBtn.disabled = true;
  showLoginFeedback('éªŒè¯ä¸­...', 'info');

  try {
    const response = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const result = await response.json();

    if (result.success) {
      isAuthenticated = true;

      // å¦‚æœç”¨æˆ·é€‰æ‹©è®°ä½å¯†ç ï¼Œåˆ™å­˜å‚¨
      if (rememberPassword.checked) {
        localStorage.setItem('dnsPanelPassword', password);
        localStorage.setItem('rememberPassword', 'true');
      } else {
        // å¦åˆ™æ¸…é™¤å­˜å‚¨çš„å¯†ç 
        localStorage.removeItem('dnsPanelPassword');
        localStorage.removeItem('rememberPassword');
      }

      showLoginFeedback('ç™»å½•æˆåŠŸï¼æ­£åœ¨åŠ è½½æ•°æ®...', 'success');
      loginModal.style.display = 'none';
      loadSubdomains();
    } else {
      showLoginFeedback(result.message || 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
      loginPassword.focus();
      loginPassword.select();
    }
  } catch (error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    showLoginFeedback('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    loginPassword.focus();
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    loginBtn.textContent = 'ç™»å½•';
    loginBtn.disabled = false;
  }
});

// æ˜¾ç¤ºç™»å½•åé¦ˆä¿¡æ¯
function showLoginFeedback(message, type) {
  loginFeedback.textContent = message;
  loginFeedback.style.color = type === 'error' ? '#e74c3c' :
                             type === 'success' ? '#27ae60' :
                             type === 'info' ? '#3498db' : '#666';
}

// æ£€æŸ¥è®¤è¯çŠ¶æ€çš„å‡½æ•°
function checkAuth() {
  if (!isAuthenticated) {
    loginModal.style.display = 'flex';
    loginPassword.focus();
    return false;
  }
  return true;
}

// åŒ…è£…éœ€è¦è®¤è¯çš„å‡½æ•°
function requireAuth(func) {
  return function(...args) {
    if (checkAuth()) {
      return func.apply(this, args);
    }
  };
}

refreshBtn.addEventListener('click', requireAuth(loadSubdomains));
registerBtn.addEventListener('click', requireAuth(() => {
  if (checkAuth()) {
    loadAccountOptions();
    modal.style.display = 'flex';
  }
}));
// ç°æœ‰å…³é—­æŒ‰é’®äº‹ä»¶ï¼ˆä¿ç•™å‘åå…¼å®¹æ€§ï¼‰
closeModal.addEventListener('click', () => modal.style.display = 'none');
closeDNSModal.addEventListener('click', () => dnsModal.style.display = 'none');
addDNSRecordBtn.addEventListener('click', () => addDNSModal.style.display = 'flex');
closeAddDNSModal.addEventListener('click', () => addDNSModal.style.display = 'none');


// å…¶ä»–æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
modalCloseBtn1.addEventListener('click', () => {
  modal.style.display = 'none';
});

modalCloseBtn3.addEventListener('click', () => {
  addDNSModal.style.display = 'none';
});

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å­˜å‚¨çš„å‡­æ®
document.addEventListener('DOMContentLoaded', function() {
  checkStoredCredentials();
});

// åŠ¨æ€åŠ è½½è´¦å·é€‰é¡¹
async function loadAccountOptions() {
  try {
    const res = await fetch('/api/subdomains');
    const data = await res.json();
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    accountSelect.innerHTML = '';
    
    // è·å–æ‰€æœ‰å”¯ä¸€è´¦å·
    const accounts = [...new Set(data.subdomains.map(sd => sd.account))];
    
    accounts.forEach(account => {
      const option = document.createElement('option');
      // ä»è´¦å·åä¸­æå–æ•°å­—ï¼Œå¦‚"è´¦å·1"æå–ä¸º"1"
      const accountIndex = account.replace('è´¦å·', '');
      option.value = accountIndex;
      option.textContent = account;
      accountSelect.appendChild(option);
    });
    
    // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œåˆ™é»˜è®¤æ·»åŠ è´¦å·1-3çš„é€‰é¡¹
    if (accounts.length === 0) {
      for (let i = 1; i <= 3; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `è´¦å·${i}`;
        accountSelect.appendChild(option);
      }
    }
  } catch (err) {
    console.error('åŠ è½½è´¦å·é€‰é¡¹å¤±è´¥:', err);
    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæä¾›é»˜è®¤é€‰é¡¹
    accountSelect.innerHTML = '';
    for (let i = 1; i <= 3; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `è´¦å·${i}`;
      accountSelect.appendChild(option);
    }
  }
}

async function loadSubdomains() {
  tableBody.innerHTML = '<tr><td colspan="6">åŠ è½½ä¸­...</td></tr>';
  try {
    const res = await fetch('/api/subdomains');
    const data = await res.json();
    tableBody.innerHTML = '';
    if (data.success && data.subdomains.length > 0) {
      data.subdomains.forEach(sd => {
        // ä¸ºåˆ°æœŸæ—¶é—´é¢„ç•™ä½ç½®ï¼Œå®é™…å®ç°ä¸­éœ€è¦é¢å¤–APIè°ƒç”¨æ¥è·å–åˆ°æœŸæ—¶é—´
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${sd.full_domain}</td>
          <td>${sd.rootdomain}</td>
          <td>${sd.status}</td>
          <td>${sd.account}</td>
          <td>${sd.created_at}</td>
          <td>${sd.expires_at || 'N/A'}</td>
          <td>
            <button onclick="manageDNSRecords(${sd.id}, '${sd.account}')">ç®¡ç†DNS</button>
            <button onclick="renewSubdomain(${sd.id}, '${sd.account.replace('è´¦å·', '')}')">ç»­æœŸ</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    } else {
      tableBody.innerHTML = '<tr><td colspan="6">æš‚æ— å­åŸŸå</td></tr>';
    }
  } catch (err) {
    tableBody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
    console.error(err);
  }
}

// æ³¨å†Œå­åŸŸ
submitRegister.addEventListener('click', async () => {
  const accountIndex = document.getElementById('accountSelect').value;
  const subdomain = document.getElementById('subdomainInput').value;
  const rootdomain = document.getElementById('rootdomainInput').value;
  if (!subdomain || !rootdomain) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');

  const res = await fetch(`/api/subdomains`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ accountIndex, subdomain, rootdomain })
  });
  const data = await res.json();
  alert(data.success ? 'æ³¨å†ŒæˆåŠŸ' : `æ³¨å†Œå¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  modal.style.display = 'none';
  document.getElementById('subdomainInput').value = '';
  document.getElementById('rootdomainInput').value = '';
  loadSubdomains();
});

// åˆ é™¤å­åŸŸ
async function deleteSubdomain(id, accountIndex) {
  if (!confirm('ç¡®å®šåˆ é™¤è¯¥å­åŸŸåå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
  const res = await fetch(`/api/subdomains`, {
    method: 'DELETE',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ subdomain_id: id, accountIndex })
  });
  const data = await res.json();
  alert(data.success ? 'åˆ é™¤æˆåŠŸ' : `åˆ é™¤å¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  loadSubdomains();
}

// ç»­æœŸå­åŸŸ
async function renewSubdomain(id, accountIndex) {
  const res = await fetch(`/api/subdomains/renew`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ subdomain_id: id, accountIndex })
  });
  const data = await res.json();
  alert(data.success ? 'ç»­æœŸæˆåŠŸ' : `ç»­æœŸå¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  loadSubdomains();
}

// ç®¡ç†DNSè®°å½•
async function manageDNSRecords(subdomainId, account) {
  currentSubdomainId = subdomainId;
  currentAccountIndex = account.replace('è´¦å·', '');
  document.getElementById('dnsModalTitle').textContent = `DNSè®°å½•ç®¡ç† - å­åŸŸ: ${account.replace('è´¦å·', 'è´¦å·')} - ${subdomainId}`;
  
  const dnsTableBody = document.querySelector('#dnsTable tbody');
  dnsTableBody.innerHTML = '<tr><td colspan="7">åŠ è½½ä¸­...</td></tr>';
  
  try {
    const res = await fetch(`/api/dns_records`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ action: 'list', accountIndex: currentAccountIndex, subdomainId })
    });
    const data = await res.json();
    
    dnsTableBody.innerHTML = '';
    if (data.success && data.records && data.records.length > 0) {
      data.records.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${record.name || '@'}</td>
          <td>${record.type}</td>
          <td>${record.content}</td>
          <td>${record.ttl}</td>
          <td>${record.priority || ''}</td>
          <td>${record.created_at}</td>
          <td>
            <button onclick="editDNSRecord(${record.id})">ç¼–è¾‘</button>
            <button onclick="deleteDNSRecord(${record.id})">åˆ é™¤</button>
          </td>
        `;
        dnsTableBody.appendChild(tr);
      });
    } else {
      dnsTableBody.innerHTML = '<tr><td colspan="7">æš‚æ— DNSè®°å½•</td></tr>';
    }
  } catch (err) {
    dnsTableBody.innerHTML = '<tr><td colspan="7">åŠ è½½å¤±è´¥</td></tr>';
    console.error('DNSè®°å½•åŠ è½½å¤±è´¥:', err);
  }
  
  dnsModal.style.display = 'flex';
}

// æ·»åŠ DNSè®°å½•
submitDNSRecord.addEventListener('click', async () => {
  const name = document.getElementById('dnsNameInput').value || null;
  const type = document.getElementById('dnsTypeSelect').value;
  const content = document.getElementById('dnsContentInput').value;
  const ttl = parseInt(document.getElementById('dnsTTLInput').value) || 120;
  const priority = parseInt(document.getElementById('dnsPriorityInput').value);

  if (!content) return alert('è¯·å¡«å†™è®°å½•å†…å®¹');
  if (ttl < 60 || ttl > 86400) return alert('TTLå€¼å¿…é¡»åœ¨60-86400ä¹‹é—´');

  // MXå’ŒSRVè®°å½•éœ€è¦ä¼˜å…ˆçº§
  if ((type === 'MX' || type === 'SRV') && isNaN(priority)) {
    return alert('MXå’ŒSRVè®°å½•å¿…é¡»è®¾ç½®ä¼˜å…ˆçº§');
  }

  const payload = { 
    action: 'create',
    accountIndex: currentAccountIndex,
    subdomainId: currentSubdomainId, 
    type, 
    content, 
    name, 
    ttl 
  };
  
  // ä»…åœ¨éœ€è¦æ—¶æ·»åŠ priorityå­—æ®µ
  if (!isNaN(priority) && priority >= 0) {
    payload.priority = priority;
  }

  const res = await fetch(`/api/dns_records`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  alert(data.success ? 'æ·»åŠ æˆåŠŸ' : `æ·»åŠ å¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  
  if (data.success) {
    document.getElementById('dnsNameInput').value = '';
    document.getElementById('dnsContentInput').value = '';
    document.getElementById('dnsTTLInput').value = '120';
    document.getElementById('dnsPriorityInput').value = '0';
    addDNSModal.style.display = 'none';
    // Refresh the DNS records list
    manageDNSRecords(currentSubdomainId, `è´¦å·${currentAccountIndex}`);
  }
});

// ç¼–è¾‘DNSè®°å½•
async function editDNSRecord(recordId) {
  alert('ç¼–è¾‘åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ï¼Œç›®å‰è¯·å…ˆåˆ é™¤è®°å½•å†é‡æ–°åˆ›å»º');
}

// åˆ é™¤DNSè®°å½•
async function deleteDNSRecord(recordId) {
  if (!confirm('ç¡®å®šåˆ é™¤è¯¥DNSè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
  
  const res = await fetch(`/api/dns_records`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ 
      action: 'delete',
      accountIndex: currentAccountIndex,
      record_id: recordId 
    })
  });
  const data = await res.json();
  alert(data.success ? 'åˆ é™¤æˆåŠŸ' : `åˆ é™¤å¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  
  if (data.success) {
    // Refresh the DNS records list
    manageDNSRecords(currentSubdomainId, `è´¦å·${currentAccountIndex}`);
  }
}

// åŠ¨æ€åŠ è½½è´¦å·é€‰é¡¹
async function loadAccountOptions() {
  try {
    const res = await fetch('/api/subdomains');
    const data = await res.json();

    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    accountSelect.innerHTML = '';

    // è·å–æ‰€æœ‰å”¯ä¸€è´¦å·
    const accounts = [...new Set(data.subdomains.map(sd => sd.account))];

    accounts.forEach(account => {
      const option = document.createElement('option');
      // ä»è´¦å·åä¸­æå–æ•°å­—ï¼Œå¦‚"è´¦å·1"æå–ä¸º"1"
      const accountIndex = account.replace('è´¦å·', '');
      option.value = accountIndex;
      option.textContent = account;
      accountSelect.appendChild(option);
    });

    // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œåˆ™é»˜è®¤æ·»åŠ è´¦å·1-3çš„é€‰é¡¹
    if (accounts.length === 0) {
      for (let i = 1; i <= 3; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `è´¦å·${i}`;
        accountSelect.appendChild(option);
      }
    }
  } catch (err) {
    console.error('åŠ è½½è´¦å·é€‰é¡¹å¤±è´¥:', err);
    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæä¾›é»˜è®¤é€‰é¡¹
    accountSelect.innerHTML = '';
    for (let i = 1; i <= 3; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `è´¦å·${i}`;
      accountSelect.appendChild(option);
    }
  }
}

async function loadSubdomains() {
  tableBody.innerHTML = '<tr><td colspan="6">åŠ è½½ä¸­...</td></tr>';
  try {
    const res = await fetch('/api/subdomains');
    const data = await res.json();
    tableBody.innerHTML = '';
    if (data.success && data.subdomains.length > 0) {
      data.subdomains.forEach(sd => {
        // ä¸ºåˆ°æœŸæ—¶é—´é¢„ç•™ä½ç½®ï¼Œå®é™…å®ç°ä¸­éœ€è¦é¢å¤–APIè°ƒç”¨æ¥è·å–åˆ°æœŸæ—¶é—´
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${sd.full_domain}</td>
          <td>${sd.rootdomain}</td>
          <td class="${sd.status === 'active' ? 'status-active' : 'status-inactive'}">${sd.status}</td>
          <td>${sd.account}</td>
          <td>${sd.created_at}</td>
          <td>${sd.expires_at || 'N/A'}</td>
          <td>
            <button onclick="manageDNSRecords(${sd.id}, '${sd.account}')">ğŸ“‹ ç®¡ç†DNS</button>
            <button onclick="renewSubdomain(${sd.id}, '${sd.account.replace('è´¦å·', '')}')">ğŸ”„ ç»­æœŸ</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    } else {
      tableBody.innerHTML = '<tr><td colspan="6">æš‚æ— å­åŸŸå</td></tr>';
    }
  } catch (err) {
    tableBody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
    console.error(err);
  }
}

// æ³¨å†Œå­åŸŸ
submitRegister.addEventListener('click', async () => {
  const accountIndex = document.getElementById('accountSelect').value;
  const subdomain = document.getElementById('subdomainInput').value;
  const rootdomain = document.getElementById('rootdomainInput').value;
  if (!subdomain || !rootdomain) {
    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
    return;
  }

  const res = await fetch(`/api/subdomains`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ accountIndex, subdomain, rootdomain })
  });
  const data = await res.json();
  alert(data.success ? 'âœ… æ³¨å†ŒæˆåŠŸ' : `âŒ æ³¨å†Œå¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  modal.style.display = 'none';
  document.getElementById('subdomainInput').value = '';
  document.getElementById('rootdomainInput').value = '';
  loadSubdomains();
});

// åˆ é™¤å­åŸŸ (å·²ç§»é™¤æŒ‰é’®ï¼Œä½†ä¿ç•™å‡½æ•°ä»¥é˜²éœ€è¦)
async function deleteSubdomain(id, accountIndex) {
  if (!confirm('âš ï¸ ç¡®å®šåˆ é™¤è¯¥å­åŸŸåå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
  const res = await fetch(`/api/subdomains`, {
    method: 'DELETE',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ subdomain_id: id, accountIndex })
  });
  const data = await res.json();
  alert(data.success ? 'âœ… åˆ é™¤æˆåŠŸ' : `âŒ åˆ é™¤å¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  loadSubdomains();
}

// ç»­æœŸå­åŸŸ
async function renewSubdomain(id, accountIndex) {
  const res = await fetch(`/api/subdomains/renew`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ subdomain_id: id, accountIndex })
  });
  const data = await res.json();
  alert(data.success ? 'âœ… ç»­æœŸæˆåŠŸ' : `âŒ ç»­æœŸå¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
  loadSubdomains();
}

// ç®¡ç†DNSè®°å½•
async function manageDNSRecords(subdomainId, account) {
  currentSubdomainId = subdomainId;
  currentAccountIndex = account.replace('è´¦å·', '');
  document.getElementById('dnsModalTitle').textContent = `ğŸ“‹ DNSè®°å½•ç®¡ç† - å­åŸŸ: ${account.replace('è´¦å·', 'è´¦å·')} - ${subdomainId}`;

  const dnsTableBody = document.querySelector('#dnsTable tbody');
  dnsTableBody.innerHTML = '<tr><td colspan="7">ğŸ”„ åŠ è½½ä¸­...</td></tr>';

  try {
    const res = await fetch(`/api/dns_records`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ action: 'list', accountIndex: currentAccountIndex, subdomainId })
    });
    const data = await res.json();

    dnsTableBody.innerHTML = '';
    if (data.success && data.records && data.records.length > 0) {
      data.records.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${record.name || '@'}</td>
          <td>${record.type}</td>
          <td>${record.content}</td>
          <td>${record.ttl}</td>
          <td>${record.priority || ''}</td>
          <td>${record.created_at}</td>
          <td>
            <button onclick="editDNSRecord(${record.id})">âœï¸ ç¼–è¾‘</button>
            <button onclick="deleteDNSRecord(${record.id})">ğŸ—‘ï¸ åˆ é™¤</button>
          </td>
        `;
        dnsTableBody.appendChild(tr);
      });
    } else {
      dnsTableBody.innerHTML = '<tr><td colspan="7">ğŸ“‹ æš‚æ— DNSè®°å½•</td></tr>';
    }
  } catch (err) {
    dnsTableBody.innerHTML = '<tr><td colspan="7">âŒ åŠ è½½å¤±è´¥</td></tr>';
    console.error('DNSè®°å½•åŠ è½½å¤±è´¥:', err);
  }

  dnsModal.style.display = 'flex';
}

// æ·»åŠ DNSè®°å½•
submitDNSRecord.addEventListener('click', async () => {
  const name = document.getElementById('dnsNameInput').value || null;
  const type = document.getElementById('dnsTypeSelect').value;
  const content = document.getElementById('dnsContentInput').value;
  const ttl = parseInt(document.getElementById('dnsTTLInput').value) || 120;
  const priority = parseInt(document.getElementById('dnsPriorityInput').value);

  if (!content) {
    alert('è¯·å¡«å†™è®°å½•å†…å®¹');
    return;
  }
  if (ttl < 60 || ttl > 86400) {
    alert('TTLå€¼å¿…é¡»åœ¨60-86400ä¹‹é—´');
    return;
  }

  // MXå’ŒSRVè®°å½•éœ€è¦ä¼˜å…ˆçº§
  if ((type === 'MX' || type === 'SRV') && isNaN(priority)) {
    alert('MXå’ŒSRVè®°å½•å¿…é¡»è®¾ç½®ä¼˜å…ˆçº§');
    return;
  }

  const payload = {
    action: 'create',
    accountIndex: currentAccountIndex,
    subdomainId: currentSubdomainId,
    type,
    content,
    name,
    ttl
  };

  // ä»…åœ¨éœ€è¦æ—¶æ·»åŠ priorityå­—æ®µ
  if (!isNaN(priority) && priority >= 0) {
    payload.priority = priority;
  }

  const res = await fetch(`/api/dns_records`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  alert(data.success ? 'âœ… æ·»åŠ æˆåŠŸ' : `âŒ æ·»åŠ å¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);

  if (data.success) {
    document.getElementById('dnsNameInput').value = '';
    document.getElementById('dnsContentInput').value = '';
    document.getElementById('dnsTTLInput').value = '120';
    document.getElementById('dnsPriorityInput').value = '0';
    addDNSModal.style.display = 'none';
    // Refresh the DNS records list
    manageDNSRecords(currentSubdomainId, `è´¦å·${currentAccountIndex}`);
  }
});

// ç¼–è¾‘DNSè®°å½•
async function editDNSRecord(recordId) {
  alert('âœï¸ ç¼–è¾‘åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ï¼Œç›®å‰è¯·å…ˆåˆ é™¤è®°å½•å†é‡æ–°åˆ›å»º');
}

// åˆ é™¤DNSè®°å½•
async function deleteDNSRecord(recordId) {
  if (!confirm('âš ï¸ ç¡®å®šåˆ é™¤è¯¥DNSè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

  const res = await fetch(`/api/dns_records`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: 'delete',
      accountIndex: currentAccountIndex,
      record_id: recordId
    })
  });
  const data = await res.json();
  alert(data.success ? 'âœ… åˆ é™¤æˆåŠŸ' : `âŒ åˆ é™¤å¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);

  if (data.success) {
    // Refresh the DNS records list
    manageDNSRecords(currentSubdomainId, `è´¦å·${currentAccountIndex}`);
  }
}
</script>
</body>
</html>